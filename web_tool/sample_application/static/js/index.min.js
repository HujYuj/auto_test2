var g_logChanged,currentTab="env",websocketUrl="",webSocketFullUrl=getAbsoluteUrl("http",websocketUrl),abilSlotSelect=null,abilOptPortSelect=null,tddSwitchSelect=null,rruSelect=null,rruOptPortSelect=null,numOfCarrierSelect=null,bwSelect=null,powerSelect=null,dlTmSelect=null,ulTmSelect=null,rfWebsocket=null,pingWebsocket=null,runnerTabs=null,webLogRowLimit=null,logContentId="#logContent",runBtn=null,runText="Run",exeText="Execute",stopText="Stop",toTopBtn=null,toBottomBtn=null,viewLogBtn=null,viewLogText="View REST Log",stopViewLogText="Stop Viewing REST Log",pingText="Ping",stopPingText="Stop pinging";function onChangeTab(e){var t="Li";currentTab!=e&&("runner"==e?(isMatched=isEnvMatched(),isMatched?($("#"+currentTab+"Div").hide(),$("#"+currentTab+t).removeClass("active"),$("#"+e+"Div").show(),$("#"+e+t).addClass("active"),currentTab=e,$("body").css("min-height","1000px"),resizeCallback()):showCheckEnvDialog()):"env"==e?($("#"+currentTab+"Div").hide(),$("#"+currentTab+t).removeClass("active"),$("#"+e+"Div").show(),$("#"+e+t).addClass("active"),currentTab=e,$("body").css("min-height","360px"),resizeCallback()):"debug"==e&&($("#"+currentTab+"Div").hide(),$("#"+currentTab+t).removeClass("active"),$("#"+e+"Div").show(),$("#"+e+t).addClass("active"),currentTab=e,$("body").css("min-height","360px"),resizeCallback()))}function showCheckEnvDialog(){showMsg("Your BBU version does not match the required. Please re-check BBU version again.")}function showStartConfirm(){initConfirmBox(executing),showConfirm("Log content was changed. Are you sure to clear?")}function showStopConfirm(){initConfirmBox(stop),showConfirm("Are your sure to stop running?")}function showRunningXmlConfirm(){initConfirmBox(function(){clearLogs(),$("#executingForm").submit()}),showConfirm("Please reboot BBU and RRU manually first. Are you ready?")}function initLoader(){var e=$("#modal").dialog({modal:!0,dialogClass:"loading-dialog",draggable:!1,width:"104px",autoOpen:!1,open:function(e,t){$("#modal").height("99px"),$(".loading-dialog").removeClass("ui-widget ui-widget-content")}});$(document).ajaxStart(function(){e.dialog("open")}).ajaxStop(function(){e.dialog("close")})}function setupAutoupdate(){updateDialog=new UpdateDialog("#updateDialogDiv","#updateMessageDiv","#updateForceConfirmDiv",400,"#progressbar","../autoupdate","../autoupdate"),updateDialog.setCheckVersionCallback(checkVersionCallback),updateDialog.setOperationTimeout(6e4)}function scheduleAutoUpdate(){isUpdateGoingOn()||(data=new Array,data.push("csrf_token="+getToken()),updateDialog.checkVersion(null,data))}function initPingWebSocket(){(pingWebsocket=new RfWebSocket(webSocketFullUrl,"ping_message")).setMessageCallback(function(e){$pingLogContent=$("#pingLogContent"),$pingLogContent.empty(),$pingLogContent.val(e)})}function connectPingWebsockect(){pingWebsocket&&pingWebsocket.isConnected()||initPingWebSocket()}function closePingWebsocket(){pingWebsocket&&pingWebsocket.isConnected&&pingWebsocket.close()}function initWebSocket(){(rfWebsocket=new RfWebSocket(webSocketFullUrl,"runner_message")).setMessageCallback(function(e){e.startsWith("Done with return code")?(changeButtonText(runText),showMsg(e),$("#status").val("Stopped"),closeWebsocket()):(logRowNumber=getLogRowNumber(),logRowNumber>webLogRowLimit&&clearLogs(),logRowNumber++,appendMessage(escapeHtml(e)),$(logContentId).trigger("change"))})}function connectWebsockect(){rfWebsocket&&rfWebsocket.isConnected()||initWebSocket()}function closeWebsocket(){rfWebsocket&&rfWebsocket.isConnected&&rfWebsocket.close()}function appendMessage(e){var t=$(logContentId);t.val().length>0?t.prepend(e+"\n"):t.prepend(e)}function appendMessage_(e){var t=$(logContentId);t.val().length>0?t.append("\n"+e):t.append(e)}function setMessages(e){$(logContentId).text(e)}function setMessages_(e){$(logContentId);for(var t=e.split("\n"),n=0;n<t.length;n++)appendMessage(t[n])}function setCompomentInitStatus(){var e=$("#runner_type").val();""!=e&&(tabNumber=-1,"tm"===e?tabNumber=0:"l1call"===e?tabNumber=1:"bfcal"===e?tabNumber=2:"prach"===e?tabNumber=3:"fcp"===e&&(tabNumber=4),runnerTabs.setActiveTab(tabNumber)),"Running"===$("#status").val()&&(changeButtonText(stopText),initWebSocket()),triggerSelectChangeEvent(),"Running"===$("#ping_status").val()&&(changePingButtonText(stopPingText),initPingWebSocket())}function triggerSelectChangeEvent(){$("#setting select").each(function(){var e=$(this).attr("value");e.length>0&&$(this).val(e).selectmenu("refresh").trigger("selectmenuchange")})}function start(){g_logChanged?showStartConfirm():executing()}function running(){var e=$("#running_url").val(),t=$("#csrf_token").val();clearLogs();DoAjax(e,"post",{csrf_token:t},runningSuccessCallback,failedCallback)}function runningSuccessCallback(e,t,n){successCallback(e,t,n),clearLogs(),changeButtonText(stopText)}function executing(){runnerType=$("#runner_type").val(),"l1call"===runnerType||"prach"===runnerType?showRunningXmlConfirm():(clearLogs(),$("#executingForm").submit())}function stop(){var e=$("#stop_url").val(),t=$("#csrf_token").val();DoAjax(e,"post",{csrf_token:t},stopSuccessCallback,failedCallback)}function stopSuccessCallback(e,t,n){successCallback(e,t,n),changeButtonText(runText),closeWebsocket()}function beforeUnloadHandler(e){if(closeWebsocket(),g_logChanged)return"Log content was changed."}function clickCheckVersion(){isUpdateGoingOn()?(updateDialog.setDialogShown(!0),updateDialog.setUpdateType(UpdateDialog.prototype.AUTO_UPDATE_TYPE_MANUAL)):(data=new Array,data.push("csrf_token="+getToken()),updateDialog.setDialogShown(!0),updateDialog.checkVersion(UpdateDialog.prototype.AUTO_UPDATE_TYPE_MANUAL,data))}function getToken(){return $("#csrf_token").val()}function isUpdateGoingOn(){return updateDialog.isGoingOn()}function checkVersionCallback(e,t){updateSysVersionCookie(e,t),updateIcon(e)}function updateSysVersionCookie(e,t){var n=$.cookie("dut_control_auto_update");!e||n&&n==t?updateDialog.getUpdateType()==UpdateDialog.prototype.AUTO_UPDATE_TYPE_AUTO&&updateDialog.setDialogShown(!1):(updateDialog.setDialogShown(!0),$.cookie("dut_control_auto_update",t,{expires:7,path:getContext()}))}function updateIcon(e){var t=$(" #update ");e?t.addClass("newUpdate"):t.removeClass("newUpdate")}function changeButtonText(e){e===stopText?(runBtn.setText(stopText),runBtn.setPrimaryIcon("stopBtn"),disableComponents("runBtn")):e===runText&&(runBtn.setText(runText),runBtn.setPrimaryIcon("autorunBtn"),enableComponents("runBtn"))}function changeViewLogBtnText(e){e===stopViewLogText?(viewLogBtn.setText(viewLogText),disableComponents("viewLogBtn")):e===viewLogText&&(viewLogBtn.setText(stopViewLogText),enableComponents("viewLogBtn"))}function changePingButtonText(e){pingBtn.setText(e)}function disableComponents(e){$("#setting select").selectmenu("disable"),$("#runnerTabs input").prop("disabled",!0),$(".control input").checkboxradio({disabled:!0}),"runBtn"==e?viewLogBtn.disable():"viewLogBtn"==e&&runBtn.disable(),runnerTabs.disableAllTabs(),disableTab("debugLi")}function enableComponents(e){$("#setting select").selectmenu("enable"),$("#runnerTabs input").prop("disabled",!1),$(".control input").checkboxradio({disabled:!1}),"runBtn"==e?viewLogBtn.enable():"viewLogBtn"==e&&runBtn.enable(),runnerTabs.enableAllTabs(),enableTab("debugLi")}function initAjaxForms(){var e={success:function(e,t,n,o){"error"===e.type?(showMsg(e.message),changeButtonText(runText)):"success"===e.type&&(connectWebsockect(),showMsg(e.message),changeButtonText(stopText),resizeCallback())},error:function(e,t,n,o){failedCallback(e,t,n)}};$("#executingForm").ajaxForm(e)}function onRunnerTabChange(e){runnerType="","TM Test"===e?runnerType="tm":"L1 Call Test"===e?runnerType="l1call":"BF Cal Test"===e?runnerType="bfcal":"FCP Test"===e?runnerType="fcp":"Prach Test"===e&&(runnerType="prach"),$("#runner_type").val(runnerType),resizeCallback()}function initComponents(){webLogRowLimit=parseInt($("#web_log_row_limit").val()),$(".controlgroup-vertical").controlgroup(),envTabs=new RfTab("#envTabs",!1),(runnerTabs=new RfTab("#runnerTabs",!1)).setActivateCallback(onRunnerTabChange),$("#setting select").selectmenu(),$("#case_type").on("selectmenuchange",function(){var e=$(this).val(),t=$("#2ndCarrier");"1CC"===e?t.hide():t.show()}),$("#auto_generate").on("selectmenuchange",function(){"auto"===$(this).val()?(showSetting(),resizeCallback()):(hideSetting(),resizeCallback())}),$("#runnerTabs input").addClass("ui-autocomplete-input"),$(".control input").checkboxradio(),$(logContentId).on("change",function(){g_logChanged=!0}),(runBtn=new Button("#runBtn")).setPrimaryIcon("autorunBtn"),runBtn.setState(!0),runBtn.bind(function(e){e.preventDefault();var t=runBtn.getText().trim();t===runText?start():t===stopText&&showStopConfirm()}),(toTopBtn=new Button("#toTopBtn")).setPrimaryIcon("toTopBtn"),toTopBtn.setState(!0),toTopBtn.bind(function(e){e.preventDefault(),$(logContentId).scrollTop(0)}),(toBottomBtn=new Button("#toBottomBtn")).setPrimaryIcon("toBottomBtn"),toBottomBtn.setState(!0),toBottomBtn.bind(function(e){e.preventDefault();var t=$(logContentId);t.scrollTop(t[0].scrollHeight)}),(viewLogBtn=new Button("#viewLogBtn")).setPrimaryIcon("searchBtn"),viewLogBtn.setState(!0),viewLogBtn.bind(function(e){e.preventDefault();var t=viewLogBtn.getText().trim();t===viewLogText?(changeViewLogBtnText(t),clearLogs(),connectWebsockect(),disableComponents("viewLogBtn")):t===stopViewLogText&&(changeViewLogBtnText(t),closeWebsocket(),enableComponents("viewLogBtn"))});$(".ui-button").unbind("mouseover"),$(".ui-button").off("mouseover"),$(".ui-button").mouseover(function(){});var e=new Button("#refreshBtn");e.setPrimaryIcon("refreshBtn"),e.setState(!0),e.bind(function(e){e.preventDefault(),refreshLog()});var t=new Button("#downloadBtn");t.setPrimaryIcon("downloadBtn"),t.setState(!0),t.bind(function(e){e.preventDefault(),remote_download()});var n=new Button("#checkEnvBtn");n.setPrimaryIcon("checkEnvBtn"),n.setState(!0),n.bind(function(e){e.preventDefault(),checkEnv()}),pingBtn=new Button("#pingBtn"),pingBtn.setPrimaryIcon("pingBtn"),pingBtn.setState(!0),pingBtn.bind(function(e){e.preventDefault();var t=pingBtn.getText().trim();t===pingText?startPing():t===stopPingText&&stopPing()})}function startPing(){var e=$("#start_ping_url").val(),t=$("#csrf_token").val();DoAjax(e,"post",{csrf_token:t},startPingSuccessCallback,failedCallback)}function clearLogs(){$(logContentId).empty(),logRowNumber=0}function getLogRowNumber(){return $(logContentId).val().split(/\r|\r\n|\n/).length}function startPingSuccessCallback(e,t,n){"success"===e.type&&(connectPingWebsockect(),changePingButtonText(stopPingText)),showMsg(e.message)}function stopPing(){var e=$("#stop_ping_url").val(),t=$("#csrf_token").val();DoAjax(e,"post",{csrf_token:t},stopPingSuccessCallback,failedCallback)}function stopPingSuccessCallback(e,t,n){"success"===e.type&&(closePingWebsocket(),changePingButtonText(pingText)),showMsg(e.message)}function checkEnv(){var e=$("#check_env_url").val(),t=$("#csrf_token").val();DoAjax(e,"post",{csrf_token:t},checkEnvSuccessCallback,failedCallback)}function checkEnvSuccessCallback(e,t,n){"success"===e.type?(messageJson=JSON.parse(e.message),$("#actualLonerVersion").html(messageJson.loner_version),$("#actualFSVersion").html(messageJson.ps_version),$("#tip").html(messageJson.tip),$("#is_matched").val(messageJson.is_matched),updateEnvVersionCookie(messageJson.loner_version,messageJson.ps_version)):showMsg(e.message)}function updateEnvVersionCookie(e,t){var n=$(e),o=$(t);updateCookie("checkedLonerVersion",n.html()),updateCookie("checkedpFSVersion",o.html())}function isEnvMatched_(){return isMatched=$("#is_matched").val(),"True"===isMatched}function isEnvMatched(){return requiredLonerVersion=$("#requiredLonerVersion").html(),requiredFSVersion=$("#requiredFSVersion").html(),checkedLonerVersion=getCookie("checkedLonerVersion"),checkedFSVersion=getCookie("checkedpFSVersion"),requiredLonerVersion===checkedLonerVersion&&requiredFSVersion===checkedFSVersion}function refreshLog(){var e=$("#refresh_url").val(),t=$("#csrf_token").val();DoAjax(e,"GET",{csrf_token:t},refreshSuccessCallback,failedCallback)}function showSetting(){var e=$(".setting");"1CC"!=$("#case_type").val()&&$("#2ndCarrier").show(),e.show()}function hideSetting(){var e=$(".setting");"1CC"!=$("#case_type").val()&&$("#2ndCarrier").hide(),e.hide()}function refreshSuccessCallback(e,t,n){var o=e.type;"success"===o?(clearLogs(),setMessages(e.message),logRowNumber=getLogRowNumber(),$(logContentId).trigger("change")):"error"===o&&showMsg(e.message)}function successCallback(e,t,n){showMsg(e.message)}function failedCallback(e,t,n){0===e.readyState&&"error"===t?showMsg("Server not reachable."):4===e.readyState?(errorMessage=parseHtmlErrorMessage(e.responseText),showMsg(mappingErrors(errorMessage))):showMsg(t)}function mappingErrors(e){return newMsg={"400 Bad Request:The CSRF session token is missing.":"Session timed out, please refresh the page.","400 Bad Request:The CSRF token has expired.":"Session timed out, please refresh the page."}[e],newMsg||(newMsg=e),newMsg}function downloadSuccessCallback(e,t,n){"error"===e.type?showMsg(e.message):local_download("",e)}function remote_download(){var e=$("#download_url").val(),t=$("#csrf_token").val();DoAjax(e,"GET",{csrf_token:t},downloadSuccessCallback,failedCallback)}function local_download(e,t){var n=document.createElement("a");if(n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),n.setAttribute("download",e),document.createEvent){var o=document.createEvent("MouseEvents");o.initEvent("click",!0,!0),n.dispatchEvent(o)}else n.click()}function resizeCallback(){resizeContentWrapperHeight(cleanTaHeight),resizeTextArea()}function initResizeForWindow(){$(window).resize(resizeCallback)}function cleanTaHeight(){$(logContentId).css("height","")}function resizeTextArea(){var e=$(logContentId);e.css("height","");var t=$(".content-wrapper"),n=t.width(),o=t.height(),a=$("#setting").outerHeight(!0),s=$("#control").outerHeight(!0),i=$("#logContentDiv").outerHeight(!0),r=e.height(),c=o-a-s-i;c>0&&e.height(c+r),e.css("width",n)}$(document).ready(function(){initResizeForWindow(),initComponents(),initDebugComponents(),initMsgBox(),bindLoadLister(resizeCallback),bindBeforeUnloadLister(beforeUnloadHandler),initAjaxForms(),setCompomentInitStatus(),setDebugCompomentInitStatus(),initLoader(),setupAutoupdate(),resizeCallback()});